import{au as e,q as s,L as t,J as n,bA as r,p as o,d as i,bB as a,x as h,g as c,e as u,ac as d,a as f,bC as l}from"./index-C7lpuH7l.esm.min.js";h._instancedMeshFactory=(e,s)=>{const t=new g(e,s);if(s.instancedBuffers){t.instancedBuffers={};for(const e in s.instancedBuffers)t.instancedBuffers[e]=s.instancedBuffers[e]}return t};class g extends e{constructor(e,s){super(e,s.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,s.addInstance(this),this._sourceMesh=s,this._unIndexed=s._unIndexed,this.position.copyFrom(s.position),this.rotation.copyFrom(s.rotation),this.scaling.copyFrom(s.scaling),s.rotationQuaternion&&(this.rotationQuaternion=s.rotationQuaternion.clone()),this.animations=s.animations.slice();for(const e of s.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);if(this.infiniteDistance=s.infiniteDistance,this.setPivotMatrix(s.getPivotMatrix()),s.skeleton||s.morphTargetManager||!s.hasBoundingInfo)this.refreshBoundingInfo(!0,!0);else{const e=s.getBoundingInfo();this.buildBoundingInfo(e.minimum,e.maximum)}this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&s.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&s.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&s.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&s.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&t.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,s,t){return this._sourceMesh.getVerticesData(e,s,t)}copyVerticesData(e,s){this._sourceMesh.copyVerticesData(e,s)}getVertexBuffer(e,s){return this._sourceMesh.getVertexBuffer(e,s)}setVerticesData(e,s,t,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,s,t,n),this.sourceMesh}updateVerticesData(e,s,t,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,s,t,n),this.sourceMesh}setIndices(e,s=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,s),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,s=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let t;t="object"==typeof e?e:{applySkeleton:e,applyMorph:s};const r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(t,null,n.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,s){if(super._activate(e,s),this._sourceMesh.subMeshes||t.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),s){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==r.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new o);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,i.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(i.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const s=this.sourceMesh.getLODLevels();if(s&&0!==s.length){const s=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,s.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,s=null,t,n){const r=(n||this._sourceMesh).createInstance(e);if(a.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),s&&(r.parent=s),!t)for(let e=0;e<this.getScene().meshes.length;e++){const s=this.getScene().meshes[e];s.parent===this&&s.clone(s.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,s=!1){this._sourceMesh.removeInstance(this),super.dispose(e,s)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,s,t){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,s&&s.newSourcedMesh);n&&t&&t(this,n);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(n,s,t);return n}}h.prototype.registerInstancedBuffer=function(e,s){if(this._userInstancedBuffersStorage?.vertexBuffers[e]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=s,this._userInstancedBuffersStorage.sizes[e]=32*s,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new n(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,s,!0);for(const s of this.instances)s.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},h.prototype._processInstancedBuffers=function(e,s){const t=e?e.length:0;for(const r in this.instancedBuffers){let o=this._userInstancedBuffersStorage.sizes[r];const i=this._userInstancedBuffersStorage.strides[r],a=(t+1)*i;for(;o<a;)o*=2;this._userInstancedBuffersStorage.data[r].length!=o&&(this._userInstancedBuffersStorage.data[r]=new Float32Array(o),this._userInstancedBuffersStorage.sizes[r]=o,this._userInstancedBuffersStorage.vertexBuffers[r]&&(this._userInstancedBuffersStorage.vertexBuffers[r].dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null));const h=this._userInstancedBuffersStorage.data[r];let c=0;if(s){const e=this.instancedBuffers[r]??0;e.toArray?e.toArray(h,c):e.copyToArray?e.copyToArray(h,c):h[c]=e,c+=i}for(let s=0;s<t;s++){const t=e[s].instancedBuffers[r]??0;t.toArray?t.toArray(h,c):t.copyToArray?t.copyToArray(h,c):h[c]=t,c+=i}this._userInstancedBuffersStorage.vertexBuffers[r]?this._userInstancedBuffersStorage.vertexBuffers[r].updateDirectly(h,0):(this._userInstancedBuffersStorage.vertexBuffers[r]=new n(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,i,!0),this._invalidateInstanceVertexArrayObject())}},h.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},h.prototype._disposeInstanceSpecificData=function(){for(const e in this._instanceDataStorage.renderPasses)this._instanceDataStorage.renderPasses[e].instancesBuffer?.dispose();for(this._instanceDataStorage.renderPasses={},this._instanceDataStorage.dataStorageRenderPass?.instancesBuffer?.dispose();this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}},c("BABYLON.InstancedMesh",g);class m{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[],this.spriteManagers=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const s of this.skeletons)e=e.concat(s.bones);return e}}class p extends m{}class _{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){const e=this.rootNodes;for(const s of e)s.dispose();e.length=0;const s=this.skeletons;for(const e of s)e.dispose();s.length=0;const t=this.animationGroups;for(const e of t)e.dispose();t.length=0}}class M extends m{constructor(e){super(),this._wasAddedToScene=!1,(e=e||u.LastCreatedScene)&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose()})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild();for(const e of this.spriteManagers)e.rebuild()})))}_topologicalSort(e){const s=new Map;for(const t of e)s.set(t.uniqueId,t);const n={dependsOn:new Map,dependedBy:new Map};for(const s of e){const e=s.uniqueId;n.dependsOn.set(e,new Set),n.dependedBy.set(e,new Set)}for(const t of e){const e=t.uniqueId,r=n.dependsOn.get(e);if(t instanceof g){const o=t.sourceMesh;s.has(o.uniqueId)&&(r.add(o.uniqueId),n.dependedBy.get(o.uniqueId).add(e))}const o=n.dependedBy.get(e);for(const r of t.getDescendants()){const t=r.uniqueId;if(s.has(t)){o.add(t);n.dependsOn.get(t).add(e)}}}const r=[],o=[];for(const t of e){const e=t.uniqueId;0===n.dependsOn.get(e).size&&(o.push(t),s.delete(e))}const i=o;for(;i.length>0;){const e=i.shift();r.push(e);const t=n.dependedBy.get(e.uniqueId);for(const r of Array.from(t.values())){const t=n.dependsOn.get(r);t.delete(e.uniqueId),0===t.size&&s.get(r)&&(i.push(s.get(r)),s.delete(r))}}return s.size>0&&(t.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),s.forEach((e=>{t.Error(e.name)}))),r}_addNodeAndDescendantsToList(e,s,t,n){if(t&&(!n||n(t))&&!s.has(t.uniqueId)){e.push(t),s.add(t.uniqueId);for(const r of t.getDescendants(!0))this._addNodeAndDescendantsToList(e,s,r,n)}}_isNodeInContainer(s){return s instanceof e&&-1!==this.meshes.indexOf(s)||(s instanceof r&&-1!==this.transformNodes.indexOf(s)||(s instanceof d&&-1!==this.lights.indexOf(s)||s instanceof f&&-1!==this.cameras.indexOf(s)))}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return t.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return t.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return t.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return t.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,n){this._isValidHierarchy()||s.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},o={},i=new _,a=[],c=[],u={doNotInstantiate:!0,...n},d=[],f=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(d,f,e,u.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(d,f,e,u.predicate);const l=this._topologicalSort(d),g=(s,n)=>{if(((s,t)=>{if(r[s.uniqueId]=t.uniqueId,o[t.uniqueId]=t,e&&(t.name=e(s.name)),t instanceof h){const e=t;if(e.morphTargetManager){const t=s.morphTargetManager;e.morphTargetManager=t.clone();for(let s=0;s<t.numTargets;s++){const n=t.getTarget(s),i=e.morphTargetManager.getTarget(s);r[n.uniqueId]=i.uniqueId,o[i.uniqueId]=i}}}})(s,n),s.parent){const e=r[s.parent.uniqueId],t=o[e];n.parent=t||s.parent}if(n.position&&s.position&&n.position.copyFrom(s.position),n.rotationQuaternion&&s.rotationQuaternion&&n.rotationQuaternion.copyFrom(s.rotationQuaternion),n.rotation&&s.rotation&&n.rotation.copyFrom(s.rotation),n.scaling&&s.scaling&&n.scaling.copyFrom(s.scaling),n.material){const i=n;if(i.material)if(t){const t=s.material;if(-1===c.indexOf(t)){let s=t.clone(e?e(t.name):"Clone of "+t.name);if(c.push(t),r[t.uniqueId]=s.uniqueId,o[s.uniqueId]=s,"MultiMaterial"===t.getClassName()){const n=t;for(const t of n.subMaterials)t&&(s=t.clone(e?e(t.name):"Clone of "+t.name),c.push(t),r[t.uniqueId]=s.uniqueId,o[s.uniqueId]=s);n.subMaterials=n.subMaterials.map((e=>e&&o[r[e.uniqueId]]))}}"InstancedMesh"!==i.getClassName()&&(i.material=o[r[t.uniqueId]])}else"MultiMaterial"===i.material.getClassName()?-1===this.scene.multiMaterials.indexOf(i.material)&&this.scene.addMultiMaterial(i.material):-1===this.scene.materials.indexOf(i.material)&&this.scene.addMaterial(i.material)}null===n.parent&&i.rootNodes.push(n)};for(const e of l)if("InstancedMesh"===e.getClassName()){const s=e,t=s.sourceMesh,n=r[t.uniqueId];g(s,("number"==typeof n?o[n]:t).createInstance(s.name))}else{let s=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?s=!1:u.doNotInstantiate&&(s="function"==typeof u.doNotInstantiate?!u.doNotInstantiate(e):!u.doNotInstantiate);const t=s?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!t)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);g(e,t)}for(const s of this.skeletons){if(u.predicate&&!u.predicate(s))continue;const t=s.clone(e?e(s.name):"Clone of "+s.name);for(const e of this.meshes)if(e.skeleton===s&&!e.isAnInstance){const s=o[r[e.uniqueId]];if(!s||s.isAnInstance)continue;if(s.skeleton=t,-1!==a.indexOf(t))continue;a.push(t);for(const e of t.bones)e._linkedTransformNode&&(e._linkedTransformNode=o[r[e._linkedTransformNode.uniqueId]])}i.skeletons.push(t)}for(const s of this.animationGroups){if(u.predicate&&!u.predicate(s))continue;const t=s.clone(e?e(s.name):"Clone of "+s.name,(e=>o[r[e.uniqueId]]||e));i.animationGroups.push(t)}return i}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||s.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const s=[];for(const t of this.cameras)e&&!e(t)||(this.scene.addCamera(t),s.push(t));for(const t of this.lights)e&&!e(t)||(this.scene.addLight(t),s.push(t));for(const t of this.meshes)e&&!e(t)||(this.scene.addMesh(t),s.push(t));for(const s of this.skeletons)e&&!e(s)||this.scene.addSkeleton(s);for(const s of this.animations)e&&!e(s)||this.scene.addAnimation(s);for(const s of this.animationGroups)e&&!e(s)||this.scene.addAnimationGroup(s);for(const s of this.multiMaterials)e&&!e(s)||this.scene.addMultiMaterial(s);for(const s of this.materials)e&&!e(s)||this.scene.addMaterial(s);for(const s of this.morphTargetManagers)e&&!e(s)||this.scene.addMorphTargetManager(s);for(const s of this.geometries)e&&!e(s)||this.scene.addGeometry(s);for(const t of this.transformNodes)e&&!e(t)||(this.scene.addTransformNode(t),s.push(t));for(const s of this.actionManagers)e&&!e(s)||this.scene.addActionManager(s);for(const s of this.textures)e&&!e(s)||this.scene.addTexture(s);for(const s of this.reflectionProbes)e&&!e(s)||this.scene.addReflectionProbe(s);for(const s of this.spriteManagers)e&&!e(s)||(this.scene.spriteManagers||(this.scene.spriteManagers=[]),this.scene.spriteManagers.push(s));if(s.length){const e=new Set(this.scene.meshes);for(const s of this.scene.lights)e.add(s);for(const s of this.scene.cameras)e.add(s);for(const s of this.scene.transformNodes)e.add(s);for(const s of this.skeletons)for(const t of s.bones)e.add(t);for(const t of s)t.parent&&!e.has(t.parent)&&(t.setParent?t.setParent(null):t.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||s.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(const s of this.cameras)e&&!e(s)||this.scene.removeCamera(s);for(const s of this.lights)e&&!e(s)||this.scene.removeLight(s);for(const s of this.meshes)e&&!e(s)||this.scene.removeMesh(s,!0);for(const s of this.skeletons)e&&!e(s)||this.scene.removeSkeleton(s);for(const s of this.animations)e&&!e(s)||this.scene.removeAnimation(s);for(const s of this.animationGroups)e&&!e(s)||this.scene.removeAnimationGroup(s);for(const s of this.multiMaterials)e&&!e(s)||this.scene.removeMultiMaterial(s);for(const s of this.materials)e&&!e(s)||this.scene.removeMaterial(s);for(const s of this.morphTargetManagers)e&&!e(s)||this.scene.removeMorphTargetManager(s);for(const s of this.geometries)e&&!e(s)||this.scene.removeGeometry(s);for(const s of this.transformNodes)e&&!e(s)||this.scene.removeTransformNode(s);for(const s of this.actionManagers)e&&!e(s)||this.scene.removeActionManager(s);for(const s of this.textures)e&&!e(s)||this.scene.removeTexture(s);for(const s of this.reflectionProbes)e&&!e(s)||this.scene.removeReflectionProbe(s);for(const s of this.spriteManagers)if((!e||e(s))&&this.scene.spriteManagers){const e=this.scene.spriteManagers.indexOf(s);-1!==e&&this.scene.spriteManagers.splice(e,1)}}dispose(){const e=this.cameras.slice(0);for(const s of e)s.dispose();this.cameras.length=0;const s=this.lights.slice(0);for(const e of s)e.dispose();this.lights.length=0;const t=this.meshes.slice(0);for(const e of t)e.dispose();this.meshes.length=0;const n=this.skeletons.slice(0);for(const e of n)e.dispose();this.skeletons.length=0;const r=this.animationGroups.slice(0);for(const e of r)e.dispose();this.animationGroups.length=0;const o=this.multiMaterials.slice(0);for(const e of o)e.dispose();this.multiMaterials.length=0;const i=this.materials.slice(0);for(const e of i)e.dispose();this.materials.length=0;const a=this.geometries.slice(0);for(const e of a)e.dispose();this.geometries.length=0;const h=this.transformNodes.slice(0);for(const e of h)e.dispose();this.transformNodes.length=0;const c=this.actionManagers.slice(0);for(const e of c)e.dispose();this.actionManagers.length=0;const u=this.textures.slice(0);for(const e of u)e.dispose();this.textures.length=0;const d=this.reflectionProbes.slice(0);for(const e of d)e.dispose();this.reflectionProbes.length=0;const f=this.morphTargetManagers.slice(0);for(const e of f)e.dispose();this.morphTargetManagers.length=0;const l=this.spriteManagers.slice(0);for(const e of l)e.dispose();this.spriteManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,s,t){if(e&&s)for(const n of e){let e=!0;if(t)for(const s of t)if(n===s){e=!1;break}e&&(s.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new p);for(const s in this)Object.prototype.hasOwnProperty.call(this,s)&&(this[s]=this[s]||("_environmentTexture"===s?null:[]),this._moveAssets(this.scene[s],this[s],e[s]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new h("assetContainerRootMesh",this.scene);for(const s of this.meshes)s.parent||e.addChild(s);return this.meshes.unshift(e),e}mergeAnimationsTo(e=u.LastCreatedScene,s,n=null){if(!e)return t.Error("No scene available to merge animations to"),[];const r=n||(s=>{let t=null;const n=s.animations.length?s.animations[0].targetProperty:"",r=s.name.split(".").join("").split("_primitive")[0];switch(n){case"position":case"rotationQuaternion":t=e.getTransformNodeByName(s.name)||e.getTransformNodeByName(r);break;case"influence":t=e.getMorphTargetByName(s.name)||e.getMorphTargetByName(r);break;default:t=e.getNodeByName(s.name)||e.getNodeByName(r)}return t}),o=this.getNodes();for(const e of o){const s=r(e);if(null!==s){for(const t of e.animations){const e=s.animations.filter((e=>e.targetProperty===t.targetProperty));for(const t of e){const e=s.animations.indexOf(t,0);e>-1&&s.animations.splice(e,1)}}s.animations=s.animations.concat(e.animations)}}const i=[],a=this.animationGroups.slice();for(const e of a){i.push(e.clone(e.name,r));for(const s of e.animatables)s.stop()}for(const t of s){const s=r(t.target);s&&(e.beginAnimation(s,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))}return i}populateRootNodes(){this.rootNodes.length=0;for(const e of this.meshes)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.transformNodes)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.lights)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e);for(const e of this.cameras)e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}addAllAssetsToContainer(s){if(!s)return;const t=[],n=new Set;for(t.push(s);t.length>0;){const s=t.pop();if(s instanceof h?(s.geometry&&-1===this.geometries.indexOf(s.geometry)&&this.geometries.push(s.geometry),this.meshes.push(s)):s instanceof g?this.meshes.push(s):s instanceof r?this.transformNodes.push(s):s instanceof d?this.lights.push(s):s instanceof f&&this.cameras.push(s),s instanceof e){if(s.material&&-1===this.materials.indexOf(s.material)){this.materials.push(s.material);for(const e of s.material.getActiveTextures())-1===this.textures.indexOf(e)&&this.textures.push(e)}s.skeleton&&-1===this.skeletons.indexOf(s.skeleton)&&this.skeletons.push(s.skeleton),s.morphTargetManager&&-1===this.morphTargetManagers.indexOf(s.morphTargetManager)&&this.morphTargetManagers.push(s.morphTargetManager)}for(const e of s.getChildren())n.has(e)||t.push(e);n.add(s)}this.populateRootNodes()}_getByTags(e,s,t){if(void 0===s)return e;const n=[];for(const r in e){const o=e[r];l&&l.MatchesQuery(o,s)&&(!t||t(o))&&n.push(o)}return n}getMeshesByTags(e,s){return this._getByTags(this.meshes,e,s)}getCamerasByTags(e,s){return this._getByTags(this.cameras,e,s)}getLightsByTags(e,s){return this._getByTags(this.lights,e,s)}getMaterialsByTags(e,s){return this._getByTags(this.materials,e,s).concat(this._getByTags(this.multiMaterials,e,s))}getTransformNodesByTags(e,s){return this._getByTags(this.transformNodes,e,s)}}export{M as A};
//# sourceMappingURL=assetContainer-BpinJ-Pb.esm.min.js.map
