import{L as e,r,b as t,C as n,m as a,B as o,q as i,n as s,f as l,cc as u}from"./index-C7lpuH7l.esm.min.js";import"./dumpTools-CaxzcV1w.esm.min.js";const c="image/png",T=[134,22,135,150,246,214,150,54];function d(r){const t=new DataView(r.buffer,r.byteOffset,r.byteLength);let n=0;for(let r=0;r<T.length;r++)if(t.getUint8(n++)!==T[r])return e.Error("Not a babylon environment map"),null;let a="",o=0;for(;o=t.getUint8(n++);)a+=String.fromCharCode(o);let i=JSON.parse(a);return i=p(i),i.binaryDataPosition=n,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}function p(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:c}}function f(e,r,i){const s=(i=p(i)).specular;if(!s)return Promise.resolve([]);e._lodGenerationScale=s.lodGenerationScale;const l=[],u=function(e,r){const t=(r=p(r)).specular;let n=Math.log2(r.width);if(n=Math.round(n)+1,t.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const a=new Array(n);for(let o=0;o<n;o++){a[o]=new Array(6);for(let n=0;n<6;n++){const i=t.mipmaps[6*o+n];a[o][n]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+i.position,i.length)}}return a}(r,i);l.push(_(e,u,i.imageType));const T=i.irradiance?.irradianceTexture;if(T){const s=function(e,r){r=p(r);const t=new Array(6),n=r.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){const o=n.faces[a];t[a]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+o.position,o.length)}}return t}(r,i);let u=null;i.irradiance?.irradianceTexture?.dominantDirection&&(u=t.FromArray(i.irradiance.irradianceTexture.dominantDirection)),l.push(async function(e,r,t,i=c,s=null){const l=e.getEngine(),u=new a(l,5),T=new o(l,u);e._irradianceTexture=T,T._dominantDirection=s,u.isCube=!0,u.format=n.TEXTUREFORMAT_RGBA,u.type=n.TEXTURETYPE_UNSIGNED_BYTE,u.generateMipMaps=!0,u._cachedAnisotropicFilteringLevel=null,u.generateMipMaps=!0,u.width=t,u.height=t,l.updateTextureSamplingMode(n.TEXTURE_TRILINEAR_SAMPLINGMODE,u),await y(u,[r],!1,i),l.generateMipMapsForCubemap(u),u.isReady=!0}(e,s,T.size,i.imageType,u))}return Promise.all(l)}async function m(e,r,t,a,o,i,s,l,u,c,T){return await new Promise(((d,p)=>{if(t){const t=r.createTexture(null,!0,!0,null,n.TEXTURE_NEAREST_SAMPLINGMODE,null,(e=>{p(e)}),e);a?.onEffectCreatedObservable.addOnce((n=>{n.executeWhenCompiled((()=>{a.externalTextureSamplerBinding=!0,a.onApply=n=>{n._bindTexture("textureSampler",t),n.setFloat2("scale",1,r._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([a],c,!0,i,s),r.restoreDefaultFramebuffer(),t.dispose(),URL.revokeObjectURL(o),d())}))}))}else{if(r._uploadImageToTexture(T,e,i,s),l){const t=u[s];t&&r._uploadImageToTexture(t._texture,e,i,0)}d()}}))}async function _(e,r,t=c){const a=e.getEngine();e.format=n.TEXTUREFORMAT_RGBA,e.type=n.TEXTURETYPE_UNSIGNED_BYTE,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,a.updateTextureSamplingMode(n.TEXTURE_TRILINEAR_SAMPLINGMODE,e),await y(e,r,!0,t),e.isReady=!0}async function y(e,r,t,T=c){if(!i.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const d=s(e.width)+1,p=e.getEngine();let f=!1,_=!1,y=null,g=null,E=null;const x=p.getCaps();x.textureLOD?p._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(f=!0,e.type=n.TEXTURETYPE_HALF_FLOAT):x.textureFloatRender&&x.textureFloatLinearFiltering&&(f=!0,e.type=n.TEXTURETYPE_FLOAT):f=!1:(f=!1,_=t);let R=0;if(f)p.isWebGPU?(R=1,await import("./rgbdDecode.fragment-DPTQEND3.esm.min.js")):await import("./rgbdDecode.fragment-F0EAO-6k.esm.min.js"),y=new l("rgbdDecode","rgbdDecode",null,null,1,null,n.TEXTURE_TRILINEAR_SAMPLINGMODE,p,!1,void 0,e.type,void 0,null,!1,void 0,R),e._isRGBD=!1,e.invertY=!1,g=p.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:n.TEXTURE_TRILINEAR_SAMPLINGMODE,type:e.type,format:n.TEXTUREFORMAT_RGBA});else if(e._isRGBD=!0,e.invertY=!0,_){const r=3;E={};const t=e._lodGenerationScale,i=e._lodGenerationOffset;for(let s=0;s<r;s++){const l=(d-1)*t+i,u=i+(l-i)*(1-s/(r-1)),c=Math.round(Math.min(Math.max(u,0),l)),T=new a(p,2);T.isCube=!0,T.invertY=!0,T.generateMipMaps=!1,p.updateTextureSamplingMode(n.TEXTURE_LINEAR_LINEAR,T);const f=new o(null);switch(f._isCube=!0,f._texture=T,E[c]=f,s){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f}}}const w=[];for(let t=0;t<r.length;t++)for(let n=0;n<6;n++){const a=r[t][n],o=u(a),i=new Blob([o],{type:T}),s=URL.createObjectURL(i);let l;if(p._features.forceBitmapOverHTMLImageElement)l=p.createImageBitmap(i,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((async r=>await m(r,p,f,y,s,n,t,_,E,g,e)));else{const r=new Image;r.src=s,l=new Promise(((a,o)=>{r.onload=()=>{m(r,p,f,y,s,n,t,_,E,g,e).then((()=>a())).catch((e=>{o(e)}))},r.onerror=e=>{o(e)}}))}w.push(l)}if(await Promise.all(w),r.length<d){let t;const a=Math.pow(2,d-1-r.length),o=a*a*4;switch(e.type){case n.TEXTURETYPE_UNSIGNED_BYTE:t=new Uint8Array(o);break;case n.TEXTURETYPE_HALF_FLOAT:t=new Uint16Array(o);break;case n.TEXTURETYPE_FLOAT:t=new Float32Array(o)}for(let n=r.length;n<d;n++)for(let r=0;r<6;r++)p._uploadArrayBufferViewToTexture(g?.texture||e,t,r,n)}if(g){const r=e._irradianceTexture;e._irradianceTexture=null,p._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=r}y&&y.dispose(),_&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function g(e,n){const a=(n=p(n)).irradiance;if(!a)return;const o=new r;t.FromArrayToRef(a.x,0,o.x),t.FromArrayToRef(a.y,0,o.y),t.FromArrayToRef(a.z,0,o.z),t.FromArrayToRef(a.xx,0,o.xx),t.FromArrayToRef(a.yy,0,o.yy),t.FromArrayToRef(a.zz,0,o.zz),t.FromArrayToRef(a.yz,0,o.yz),t.FromArrayToRef(a.zx,0,o.zx),t.FromArrayToRef(a.xy,0,o.xy),e._sphericalPolynomial=o}function E(e,r,t,n,a){const o=_(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),r).then((()=>e));return e.onRebuildCallback=e=>({proxy:o,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=r,e._lodGenerationScale=n,e._lodGenerationOffset=a,e._sphericalPolynomial=t,_(e,r).then((()=>(e.isReady=!0,e)))}export{d as G,g as U,E as _,f as a};
//# sourceMappingURL=environmentTextureTools-CtfceH8Q.esm.min.js.map
