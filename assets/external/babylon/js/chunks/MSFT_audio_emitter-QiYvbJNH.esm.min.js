import{O as t,b as e,e as n,af as i,L as o,a2 as s,j as a,g as r,l,k as d,p as u,aM as c,q as h,cc as p,bS as _,bR as m}from"./index-C7lpuH7l.esm.min.js";import{_ as f,a as g}from"./spatialWebAudio-B42xkSFp.esm.min.js";import{_WebAudioSoundSource as A}from"./webAudioSoundSource-9d69uvKb.esm.min.js";import{_WebAudioStaticSound as y}from"./webAudioStaticSound-B63zkTsc.esm.min.js";import{_WebAudioStreamingSound as T}from"./webAudioStreamingSound-Bb02H5Tl.esm.min.js";import{ArrayItem as C,GLTFLoader as b}from"./glTFLoader-Cy3hFpAv.esm.min.js";import"./audioEngine-Dxu8PeXf.esm.min.js";import"./webAudioBaseSubGraph-BwJfROV_.esm.min.js";import"./abstractSoundSource-WGnl6Tud.esm.min.js";import"./abstractSoundInstance-sVqCQsb0.esm.min.js";import"./bone-C8BOn9ne.esm.min.js";import"./skeleton-CpeT1KDV.esm.min.js";import"./rawTexture-GcKYJ37d.esm.min.js";import"./assetContainer-BpinJ-Pb.esm.min.js";import"./objectModelMapping-EW6prSP3.esm.min.js";class V{constructor(t,e,n){this.frame=t,this.action=e,this.onlyOnce=n,this.isDone=!1}_clone(){return new V(this.frame,this.action,this.onlyOnce)}}const P={duration:0,shape:"linear"},D={duration:0,startOffset:0,waitTime:0},S={waitTime:0};function v(t){return t*Math.PI/180}function M(t){return 180*t/Math.PI}class k{get name(){return this._soundV2.name}set name(t){this._soundV2.name=t}get autoplay(){return this._soundV2 instanceof A||this._optionsV2.autoplay}set autoplay(t){this._optionsV2.autoplay=t}get loop(){return this._soundV2 instanceof A||this._soundV2.loop}set loop(t){this._soundV2 instanceof A||this._soundV2&&(this._soundV2.loop=t)}get isPlaying(){return this._soundV2 instanceof A||(3===this._soundV2?.state||!this.isReady()&&this._optionsV2.autoplay)}get isPaused(){return!(this._soundV2 instanceof A)&&5===this._soundV2.state}get maxDistance(){return this._optionsV2.spatialMaxDistance||100}set maxDistance(t){this._optionsV2.spatialMaxDistance=t,this.useCustomAttenuation||this._soundV2&&(this._initSpatial(),this._soundV2.spatial.maxDistance=t)}get distanceModel(){return this._optionsV2.spatialDistanceModel||"linear"}set distanceModel(t){this._optionsV2.spatialDistanceModel=t,this._soundV2&&(this._initSpatial(),this._soundV2.spatial.distanceModel=t)}get currentTime(){return this._soundV2 instanceof A?this._soundV2.engine.currentTime:this._soundV2.currentTime}get spatialSound(){return this._soundV2?._isSpatial??!1}set spatialSound(t){this._soundV2&&(t?this._initSpatial():this._soundV2._isSpatial=!1)}get _onReady(){return this._onReadyObservable||(this._onReadyObservable=new t),this._onReadyObservable}constructor(s,a,r,l=null,d){if(this.useCustomAttenuation=!1,this.soundTrackId=-1,this.refDistance=1,this.rolloffFactor=1,this.metadata=null,this.onEndedObservable=new t,this._localDirection=new e(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._isOutputConnected=!1,this._url=null,this._onReadyObservable=null,this._onReadyToPlay=()=>{this._scene.mainSoundTrack.addSound(this),this._isReadyToPlay=!0,this._readyToPlayCallback(),this._onReadyObservable&&this._onReadyObservable.notifyObservers(),this._optionsV2.autoplay&&this.play()},this._onended=()=>{this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},!(r=r||n.LastCreatedScene))return;this._scene=r,k._SceneComponentInitialization(r),this._readyToPlayCallback=l||(()=>{}),this._customAttenuationFunction=(t,e,n,i,o)=>e<n?t*(1-e/n):0;const u={analyzerEnabled:!1,autoplay:!1,duration:(d=d||{}).length||0,loop:d.loop||!1,loopEnd:0,loopStart:0,outBus:null,outBusAutoDefault:!1,playbackRate:d.playbackRate||1,pitch:0,skipCodecCheck:d.skipCodecCheck||!1,spatialDistanceModel:d.distanceModel,spatialEnabled:d.spatialSound,spatialMaxDistance:d.maxDistance,spatialMinDistance:d.refDistance,spatialRolloffFactor:d.rolloffFactor,stereoEnabled:!1,startOffset:d.offset||0,volume:d.volume??1};this._volume=d.volume??1,f(u)&&(u.spatialAutoUpdate=!1,u.spatialConeInnerAngle=g.coneInnerAngle,u.spatialConeOuterAngle=g.coneOuterAngle,u.spatialConeOuterVolume=g.coneOuterVolume,u.spatialMinUpdateTime=0,u.spatialOrientation=g.orientation.clone(),u.spatialPanningModel=this._scene.headphone?"HRTF":"equalpower",u.spatialPosition=g.position.clone(),u.spatialRotation=g.rotation.clone(),u.spatialRotationQuaternion=g.rotationQuaternion.clone(),void 0===u.spatialMaxDistance&&(u.spatialMaxDistance=100)),this._optionsV2={...u},this._optionsV2.autoplay=d.autoplay||!1,this.useCustomAttenuation=d.useCustomAttenuation??!1,this.useCustomAttenuation&&(u.spatialMaxDistance=Number.MAX_VALUE,u.volume=0);let c=d?.streaming||!1;if(!i.audioEngine)return;const h=i.audioEngine._v2,p=()=>{if(c){const t={preloadCount:0,...u},e=new T(s,h,t);return e._initAsync(a,u).then((()=>{e.preloadInstancesAsync(1).then(this._onReadyToPlay)})),e}{const t=new y(s,h,u);return t._initAsync(a,u).then(this._onReadyToPlay),t}};if(a)if("string"==typeof a)this._url=a,this._soundV2=p();else if(a instanceof ArrayBuffer)c=!1,this._soundV2=p();else if(a instanceof HTMLMediaElement)c=!0,this._soundV2=p();else if(a instanceof MediaStream){const t=new MediaStreamAudioSourceNode(h._audioContext,{mediaStream:a});this._soundV2=new A(s,t,h,u),this._soundV2._initAsync(u).then(this._onReadyToPlay)}else a instanceof AudioBuffer?(c=!1,this._soundV2=p()):Array.isArray(a)&&(this._soundV2=p());else this._soundV2=new y(s,h,u);this._soundV2?this._soundV2 instanceof A||this._soundV2.onEndedObservable.add(this._onended):o.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}dispose(){this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._soundV2.dispose()}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}setAudioBuffer(t){this._isReadyToPlay||this._soundV2 instanceof y&&this._soundV2._initAsync(t,this._optionsV2).then(this._onReadyToPlay)}updateOptions(t){if(t){if(this.loop=t.loop??this.loop,this.maxDistance=t.maxDistance??this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor??this.rolloffFactor,this.refDistance=t.refDistance??this.refDistance,this.distanceModel=t.distanceModel??this.distanceModel,void 0!==t.playbackRate&&this.setPlaybackRate(t.playbackRate),void 0!==t.spatialSound&&(this.spatialSound=t.spatialSound),void 0!==t.volume&&this.setVolume(t.volume),this._soundV2 instanceof y){let e=!1;void 0!==t.offset&&(this._optionsV2.startOffset=t.offset,e=!0),void 0!==t.length&&(this._soundV2.duration=t.length,e=!0),e&&this.isPaused&&this.stop()}this._updateSpatialParameters()}}_updateSpatialParameters(){if(!this.spatialSound)return;const t=this._soundV2.spatial;this.useCustomAttenuation?(t.distanceModel="linear",t.minDistance=1,t.maxDistance=Number.MAX_VALUE,t.rolloffFactor=1,t.panningModel="equalpower"):(t.distanceModel=this.distanceModel,t.minDistance=this.refDistance,t.maxDistance=this.maxDistance,t.rolloffFactor=this.rolloffFactor,t.panningModel=this._optionsV2.spatialPanningModel||"equalpower")}switchPanningModelToHRTF(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="HRTF")}switchPanningModelToEqualPower(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="equalpower")}connectToSoundTrackAudioNode(t){const e=this._soundV2._outNode;e&&(this._isOutputConnected&&e.disconnect(),e.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,e,n){e<t?o.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._optionsV2.spatialConeInnerAngle=v(t),this._optionsV2.spatialConeOuterAngle=v(e),this._optionsV2.spatialConeOuterVolume=n,this._initSpatial(),this._soundV2.spatial.coneInnerAngle=this._optionsV2.spatialConeInnerAngle,this._soundV2.spatial.coneOuterAngle=this._optionsV2.spatialConeOuterAngle,this._soundV2.spatial.coneOuterVolume=n,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration)))}get directionalConeInnerAngle(){return M("number"==typeof this._optionsV2.spatialConeInnerAngle?this._optionsV2.spatialConeInnerAngle:g.coneInnerAngle)}set directionalConeInnerAngle(t){if((t=v(t))!=this._optionsV2.spatialConeInnerAngle){if(this.directionalConeOuterAngle<t)return void o.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._optionsV2.spatialConeInnerAngle=t,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneInnerAngle=t)}}get directionalConeOuterAngle(){return M("number"==typeof this._optionsV2.spatialConeOuterAngle?this._optionsV2.spatialConeOuterAngle:g.coneOuterAngle)}set directionalConeOuterAngle(t){if((t=v(t))!=this._optionsV2.spatialConeOuterAngle){if(t<this.directionalConeInnerAngle)return void o.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._optionsV2.spatialConeOuterAngle=t,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneOuterAngle=t)}}setPosition(t){this._optionsV2.spatialPosition&&t.equals(this._optionsV2.spatialPosition)||(this._optionsV2.spatialPosition||(this._optionsV2.spatialPosition=e.Zero()),this._optionsV2.spatialPosition.copyFrom(t),!this.spatialSound||isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||(this._initSpatial(),this._soundV2.spatial.position=t))}setLocalDirectionToMesh(t){this._localDirection=t,this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this.spatialSound)return;const t=this._connectedTransformNode.getWorldMatrix(),n=e.TransformNormal(this._localDirection,t);n.normalize(),this._initSpatial(),this._soundV2.spatial.orientation=n}_initSpatial(){this._soundV2._isSpatial=!0,void 0===this._optionsV2.spatialDistanceModel&&(this._optionsV2.spatialDistanceModel="linear",this._soundV2.spatial.distanceModel="linear"),void 0===this._optionsV2.spatialMaxDistance&&(this._optionsV2.spatialMaxDistance=100,this._soundV2.spatial.maxDistance=100)}updateDistanceFromListener(){if(this._soundV2._outNode&&this._connectedTransformNode&&this.useCustomAttenuation&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundV2.volume=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,e,n){const s=i.audioEngine;if(s?.unlock(),!(this._soundV2 instanceof A)&&this._isReadyToPlay&&this._scene.audioEnabled){5!==this._soundV2.state||void 0===t&&void 0===e&&void 0===n||this._soundV2.stop();try{D.duration=n||0,D.startOffset=void 0!==e&&e||this._optionsV2.startOffset,D.waitTime=t||0,D.loop=void 0,D.loopStart=void 0,D.loopEnd=void 0,D.volume=void 0,s?.unlocked?this._soundV2.play(D):setTimeout((()=>{this._soundV2.play(D)}),500)}catch(t){o.Error("Error while trying to play audio: "+this.name+", "+t.message)}}}stop(t){this._soundV2&&(this._soundV2 instanceof A||(S.waitTime=t||0,this._soundV2.stop(S)))}pause(){this._soundV2&&(this._soundV2 instanceof A||this._soundV2.pause())}setVolume(t,e){this.isReady()?(P.duration=e||0,this._soundV2.setVolume(t,P),this._volume=t):this._onReady.addOnce((()=>{this.setVolume(t,e)}))}setPlaybackRate(t){this._soundV2 instanceof y&&(this._soundV2.playbackRate=t)}getPlaybackRate(){return this._soundV2 instanceof y?this._soundV2.playbackRate:1}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this.spatialSound||(this.spatialSound=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){if(t.getBoundingInfo){const e=t.getBoundingInfo();this.setPosition(e.boundingSphere.centerWorld)}else this.setPosition(t.absolutePosition);this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(!(this._soundV2 instanceof y))return null;const t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},e=new k(this.name+"_cloned",this._soundV2.buffer,this._scene,null,t);return e._optionsV2=this._optionsV2,this.useCustomAttenuation&&e.setAttenuationFunction(this._customAttenuationFunction),e}getAudioBuffer(){return this._soundV2 instanceof y?this._soundV2.buffer._audioBuffer:null}getSoundSource(){return null}getSoundGain(){return this._soundV2._outNode}serialize(){const t={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this.getPlaybackRate(),panningModel:this._soundV2.spatial.panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._soundV2.spatial.position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this.directionalConeInnerAngle,t.coneOuterAngle=this.directionalConeOuterAngle,t.coneOuterGain=this._soundV2.spatial.coneOuterVolume),t}static Parse(t,n,i,o){const a=t.name;let r;r=t.url?i+t.url:i+a;const l={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate};let d;if(o){const t=()=>{s((()=>o._isReadyToPlay),(()=>{const t=o.getAudioBuffer();t&&d.setAudioBuffer(t),d._isReadyToPlay=!0,d.autoplay&&d.play(0,o._optionsV2.startOffset,o._optionsV2.duration)}),void 0,300)};d=new k(a,new ArrayBuffer(0),n,null,l),t()}else d=new k(a,r,n,(()=>{n.removePendingData(d)}),l),n.addPendingData(d);if(t.position){const n=e.FromArray(t.position);d.setPosition(n)}if(t.isDirectional&&(d.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){const n=e.FromArray(t.localDirectionToMesh);d.setLocalDirectionToMesh(n)}if(t.connectedMeshId){const e=n.getMeshById(t.connectedMeshId);e&&d.attachToMesh(e)}return t.metadata&&(d.metadata=t.metadata),d}}k._SceneComponentInitialization=t=>{throw a("AudioSceneComponent")},r("BABYLON.Sound",k);class w{constructor(t,e,n){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],e.length!==n.length)throw new Error("Sounds length does not equal weights length");this.loop=t,this._weights=n;let i=0;for(const t of n)i+=t;const o=i>0?1/i:0;for(let t=0;t<this._weights.length;t++)this._weights[t]*=o;this._sounds=e;for(const t of this._sounds)t.onEndedObservable.add((()=>{this._onended()}))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!==this._coneInnerAngle){if(this._coneOuterAngle<t)return void o.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=t;for(const e of this._sounds)e.directionalConeInnerAngle=t}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!==this._coneOuterAngle){if(t<this._coneInnerAngle)return void o.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=t;for(const e of this._sounds)e.directionalConeOuterAngle=t}}get volume(){return this._volume}set volume(t){if(t!==this._volume)for(const e of this._sounds)e.setVolume(t)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(t){if(!this.isPaused){this.stop();const t=Math.random();let e=0;for(let n=0;n<this._weights.length;n++)if(e+=this._weights[n],t<=e){this._currentIndex=n;break}}const e=this._sounds[this._currentIndex??0];e.isReady()?e.play(0,this.isPaused?void 0:t):e.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class E{constructor(t,e={}){this.id=-1,this._isInitialized=!1,(t=t||n.LastCreatedScene)&&(this._scene=t,this.soundCollection=[],this._options=e,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){i.audioEngine?.canUseWebAudio&&i.audioEngine.audioContext&&(this._outputAudioNode=i.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(i.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(i.audioEngine&&i.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(t){this._isInitialized||this._initializeSoundTrackAudioGraph(),i.audioEngine?.canUseWebAudio&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==t.soundTrackId&&(-1===t.soundTrackId?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id}removeSound(t){const e=this.soundCollection.indexOf(t);-1!==e&&this.soundCollection.splice(e,1)}setVolume(t){i.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t)}switchPanningModelToHRTF(){if(i.audioEngine?.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(i.audioEngine?.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,i.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,i.audioEngine.masterGain))}}Object.defineProperty(l.prototype,"mainSoundTrack",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),this._mainSoundTrack||(this._mainSoundTrack=new E(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),l.prototype.getSoundByName=function(t){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===t)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks)for(let n=0;n<this.soundTracks.length;n++)for(e=0;e<this.soundTracks[n].soundCollection.length;e++)if(this.soundTracks[n].soundCollection[e].name===t)return this.soundTracks[n].soundCollection[e];return null},Object.defineProperty(l.prototype,"audioEnabled",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),t.audioEnabled},set:function(t){let e=this._getComponent(d.NAME_AUDIO);e||(e=new O(this),this._addComponent(e)),t?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"headphone",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),t.headphone},set:function(t){let e=this._getComponent(d.NAME_AUDIO);e||(e=new O(this),this._addComponent(e)),t?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"audioListenerPositionProvider",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),t.audioListenerPositionProvider},set:function(t){let e=this._getComponent(d.NAME_AUDIO);if(e||(e=new O(this),this._addComponent(e)),t&&"function"!=typeof t)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=t},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"audioListenerRotationProvider",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),t.audioListenerRotationProvider},set:function(t){let e=this._getComponent(d.NAME_AUDIO);if(e||(e=new O(this),this._addComponent(e)),t&&"function"!=typeof t)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=t},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"audioPositioningRefreshRate",{get:function(){let t=this._getComponent(d.NAME_AUDIO);return t||(t=new O(this),this._addComponent(t)),t.audioPositioningRefreshRate},set:function(t){let e=this._getComponent(d.NAME_AUDIO);e||(e=new O(this),this._addComponent(e)),e.audioPositioningRefreshRate=t},enumerable:!0,configurable:!0});class O{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(t){this.name=d.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new e,this._cachedCameraPosition=new e,this._lastCheck=0,this._invertMatrixTemp=new u,this._cameraDirectionTemp=new e,(t=t||n.LastCreatedScene)&&(this.scene=t,t.soundTracks=[],t.sounds=[])}register(){this.scene._afterRenderStage.registerStep(d.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(t){if(t.sounds=[],this.scene.soundTracks)for(let e=0;e<this.scene.soundTracks.length;e++){const n=this.scene.soundTracks[e];for(let e=0;e<n.soundCollection.length;e++)t.sounds.push(n.soundCollection[e].serialize())}}addFromContainer(t){if(t.sounds)for(const e of t.sounds)e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)}removeFromContainer(t,e=!1){if(t.sounds)for(const n of t.sounds)n.stop(),n.autoplay=!1,this.scene.mainSoundTrack.removeSound(n),e&&n.dispose()}dispose(){const t=this.scene;if(t._mainSoundTrack&&t.mainSoundTrack.dispose(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].dispose()}disableAudio(){const t=this.scene;let e;for(this._audioEnabled=!1,i.audioEngine&&i.audioEngine.audioContext&&i.audioEngine.audioContext.suspend(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let n=0;n<t.soundTracks[e].soundCollection.length;n++)t.soundTracks[e].soundCollection[n].pause()}enableAudio(){const t=this.scene;let e;for(this._audioEnabled=!0,i.audioEngine&&i.audioEngine.audioContext&&i.audioEngine.audioContext.resume(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let n=0;n<t.soundTracks[e].soundCollection.length;n++)t.soundTracks[e].soundCollection[n].isPaused&&t.soundTracks[e].soundCollection[n].play()}switchAudioModeForHeadphones(){const t=this.scene;if(this._headphone=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const t=this.scene;if(this._headphone=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToEqualPower()}_afterRender(){const t=c.Now;if(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=t;const n=this.scene;if(!this._audioEnabled||!n._mainSoundTrack||!n.soundTracks||0===n._mainSoundTrack.soundCollection.length&&1===n.soundTracks.length)return;const o=i.audioEngine;if(o&&o.audioContext){let t,i=n.activeCamera;if(n.activeCameras&&n.activeCameras.length>0&&(i=n.activeCameras[0]),this.audioListenerPositionProvider){const t=this.audioListenerPositionProvider();o.audioContext.listener.setPosition(t.x||0,t.y||0,t.z||0)}else i?this._cachedCameraPosition.equals(i.globalPosition)||(this._cachedCameraPosition.copyFrom(i.globalPosition),o.audioContext.listener.setPosition(i.globalPosition.x,i.globalPosition.y,i.globalPosition.z)):o.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const t=this.audioListenerRotationProvider();o.audioContext.listener.setOrientation(t.x||0,t.y||0,t.z||0,0,1,0)}else i?(i.rigCameras&&i.rigCameras.length>0&&(i=i.rigCameras[0]),i.getViewMatrix().invertToRef(this._invertMatrixTemp),e.TransformNormalToRef(O._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),o.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):o.audioContext.listener.setOrientation(0,0,0,0,1,0);for(t=0;t<n.mainSoundTrack.soundCollection.length;t++){const e=n.mainSoundTrack.soundCollection[t];e.useCustomAttenuation&&e.updateDistanceFromListener()}if(n.soundTracks)for(t=0;t<n.soundTracks.length;t++)for(let e=0;e<n.soundTracks[t].soundCollection.length;e++){const i=n.soundTracks[t].soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}}}}O._CameraDirection=new e(0,0,-1),k._SceneComponentInitialization=t=>{let e=t._getComponent(d.NAME_AUDIO);e||(e=new O(t),t._addComponent(e))};const x="MSFT_audio_emitter";class R{constructor(t){this.name=x,this._loader=t,this.enabled=this._loader.isExtensionUsed(x)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const e=t[this.name];this._clips=e.clips,this._emitters=e.emitters,C.Assign(this._clips),C.Assign(this._emitters)}}loadSceneAsync(t,e){return b.LoadExtensionAsync(t,e,this.name,(async(n,i)=>{const o=new Array;o.push(this._loader.loadSceneAsync(t,e));for(const t of i.emitters){const e=C.Get(`${n}/emitters`,this._emitters,t);if(null!=e.refDistance||null!=e.maxDistance||null!=e.rolloffFactor||null!=e.distanceModel||null!=e.innerAngle||null!=e.outerAngle)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);o.push(this._loadEmitterAsync(`${n}/emitters/${e.index}`,e))}await Promise.all(o)}))}loadNodeAsync(t,n,i){return b.LoadExtensionAsync(t,n,this.name,(async(t,o)=>{const s=new Array,a=await this._loader.loadNodeAsync(t,n,(n=>{for(const i of o.emitters){const o=C.Get(`${t}/emitters`,this._emitters,i);s.push(this._loadEmitterAsync(`${t}/emitters/${o.index}`,o).then((()=>{for(const t of o._babylonSounds)t.attachToMesh(n),null==o.innerAngle&&null==o.outerAngle||(t.setLocalDirectionToMesh(e.Forward()),t.setDirectionalCone(2*h.ToDegrees(null==o.innerAngle?Math.PI:o.innerAngle),2*h.ToDegrees(null==o.outerAngle?Math.PI:o.outerAngle),0))})))}i(n)}));return await Promise.all(s),a}))}loadAnimationAsync(t,e){return b.LoadExtensionAsync(t,e,this.name,(async(n,i)=>{const o=await this._loader.loadAnimationAsync(t,e),s=new Array;C.Assign(i.events);for(const a of i.events)s.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,t,e,a,o));return await Promise.all(s),o}))}_loadClipAsync(t,e){if(e._objectURL)return e._objectURL;let n;if(e.uri)n=this._loader.loadUriAsync(t,e,e.uri);else{const i=C.Get(`${t}/bufferView`,this._loader.gltf.bufferViews,e.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}return e._objectURL=n.then((t=>{const n=p(t);return URL.createObjectURL(new Blob([n],{type:e.mimeType}))})),e._objectURL}_loadEmitterAsync(t,e){if(e._babylonSounds=e._babylonSounds||[],!e._babylonData){const t=new Array,n=e.name||`emitter${e.index}`,i={loop:!1,autoplay:!1,volume:null==e.volume?1:e.volume};for(let o=0;o<e.clips.length;o++){const s=`/extensions/${this.name}/clips`,a=C.Get(s,this._clips,e.clips[o].clip);t.push(this._loadClipAsync(`${s}/${e.clips[o].clip}`,a).then((t=>{const s=e._babylonSounds[o]=new k(n,t,this._loader.babylonScene,null,i);s.refDistance=e.refDistance||1,s.maxDistance=e.maxDistance||256,s.rolloffFactor=e.rolloffFactor||1,s.distanceModel=e.distanceModel||"exponential"})))}const o=Promise.all(t).then((()=>{const t=e.clips.map((t=>t.weight||1)),n=new w(e.loop||!1,e._babylonSounds,t);e.innerAngle&&(n.directionalConeInnerAngle=2*h.ToDegrees(e.innerAngle)),e.outerAngle&&(n.directionalConeOuterAngle=2*h.ToDegrees(e.outerAngle)),e.volume&&(n.volume=e.volume),e._babylonData.sound=n}));e._babylonData={loaded:o}}return e._babylonData.loaded}_getEventAction(t,e,n,i,o){switch(n){case"play":return t=>{const n=(o||0)+(t-i);e.play(n)};case"stop":return()=>{e.stop()};case"pause":return()=>{e.pause()};default:throw new Error(`${t}: Unsupported action ${n}`)}}_loadAnimationEventAsync(t,e,n,i,o){if(0==o.targetedAnimations.length)return Promise.resolve();const s=o.targetedAnimations[0],a=i.emitter,r=C.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(t,r).then((()=>{const e=r._babylonData.sound;if(e){const n=new V(i.time,this._getEventAction(t,e,i.action,i.time,i.startOffset));s.animation.addEvent(n),o.onAnimationGroupEndObservable.add((()=>{e.stop()})),o.onAnimationGroupPauseObservable.add((()=>{e.pause()}))}}))}}_(x),m(x,!0,(t=>new R(t)));export{R as MSFT_audio_emitter};
//# sourceMappingURL=MSFT_audio_emitter-QiYvbJNH.esm.min.js.map
