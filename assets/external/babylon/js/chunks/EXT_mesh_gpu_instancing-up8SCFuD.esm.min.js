import{d as e,b as s,Q as t,p as o,L as r,bS as n,bR as a}from"./index-C7lpuH7l.esm.min.js";import{GLTFLoader as i,ArrayItem as c}from"./glTFLoader-Cy3hFpAv.esm.min.js";import"./thinInstanceMesh-BRurJ3_A.esm.min.js";import"./bone-C8BOn9ne.esm.min.js";import"./skeleton-CpeT1KDV.esm.min.js";import"./rawTexture-GcKYJ37d.esm.min.js";import"./assetContainer-BpinJ-Pb.esm.min.js";import"./objectModelMapping-EW6prSP3.esm.min.js";const m="EXT_mesh_gpu_instancing";class l{constructor(e){this.name=m,this._loader=e,this.enabled=this._loader.isExtensionUsed(m)}dispose(){this._loader=null}loadNodeAsync(n,a,m){return i.LoadExtensionAsync(n,a,this.name,(async(n,i)=>{this._loader._disableInstancedMesh++;const l=this._loader.loadNodeAsync(`/nodes/${a.index}`,a,m);if(this._loader._disableInstancedMesh--,!a._primitiveBabylonMeshes)return await l;const d=new Array;let h=0;const u=e=>{if(null==i.attributes[e])return void d.push(Promise.resolve(null));const s=c.Get(`${n}/attributes/${e}`,this._loader.gltf.accessors,i.attributes[e]);if(d.push(this._loader._loadFloatAccessorAsync(`/accessors/${s.bufferView}`,s)),0===h)h=s.count;else if(h!==s.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return u("TRANSLATION"),u("ROTATION"),u("SCALE"),u("_COLOR_0"),await l.then((async n=>{const[i,c,m,l]=await Promise.all(d),u=new Float32Array(16*h);e.Vector3[0].copyFromFloats(0,0,0),e.Quaternion[0].copyFromFloats(0,0,0,1),e.Vector3[1].copyFromFloats(1,1,1);for(let r=0;r<h;++r)i&&s.FromArrayToRef(i,3*r,e.Vector3[0]),c&&t.FromArrayToRef(c,4*r,e.Quaternion[0]),m&&s.FromArrayToRef(m,3*r,e.Vector3[1]),o.ComposeToRef(e.Vector3[1],e.Quaternion[0],e.Vector3[0],e.Matrix[0]),e.Matrix[0].copyToArray(u,16*r);for(const e of a._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",u,16,!0),l&&(l.length===3*h?e.thinInstanceSetBuffer("color",l,3,!0):l.length===4*h?e.thinInstanceSetBuffer("color",l,4,!0):r.Warn("Unexpected size of _COLOR_0 attribute for mesh "+e.name));return n}))}))}}n(m),a(m,!0,(e=>new l(e)));export{l as EXT_mesh_gpu_instancing};
//# sourceMappingURL=EXT_mesh_gpu_instancing-up8SCFuD.esm.min.js.map
