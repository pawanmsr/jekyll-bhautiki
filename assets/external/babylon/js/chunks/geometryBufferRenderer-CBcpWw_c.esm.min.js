import{H as e,C as t,h as i,J as n,K as s,N as r,W as a,X as o,M as l,T as d,p as u,Y as c,Z as f,$ as h,i as T,a0 as E,j as _}from"./index-C7lpuH7l.esm.min.js";import"./clipPlaneFragment-tBT19CLp.esm.min.js";import"./bumpFragment-CQC-fmF5.esm.min.js";import"./helperFunctions-Bt-rj6dw.esm.min.js";import"./bakedVertexAnimation-C1n5K-7S.esm.min.js";import"./morphTargetsVertex-DHnQTyrj.esm.min.js";import"./instancesDeclaration-C61GJtkH.esm.min.js";import"./sceneUboDeclaration-C0IDfgqW.esm.min.js";import"./clipPlaneVertex-C37mL-i1.esm.min.js";import"./bumpVertex-CXvTIDyT.esm.min.js";const p="mrtFragmentDeclaration";e.IncludesShadersStore[p]||(e.IncludesShadersStore[p]="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n");const m="geometryPixelShader",v="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#else\n#ifdef METALLIC_TEXTURE\nuniform sampler2D metallicSampler;varying vec2 vMetallicUV;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nuniform sampler2D roughnessSampler;varying vec2 vRoughnessUV;\n#endif\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#elif defined(HAS_NORMAL_ATTRIBUTE)\nnormalOutput=normalize(vNormalV);\n#elif defined(POSITION)\nnormalOutput=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\n#ifdef DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\ngl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -\n(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#else\n#ifdef METALLIC_TEXTURE\nmetal*=texture2D(metallicSampler,vMetallicUV).r;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nroughness*=texture2D(roughnessSampler,vRoughnessUV).r;\n#endif\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";e.ShadersStore[m]||(e.ShadersStore[m]=v);const g={name:m,shader:v};var x=Object.freeze({__proto__:null,geometryPixelShader:g});const R="geometryVertexDeclaration";e.IncludesShadersStore[R]||(e.IncludesShadersStore[R]="uniform mat4 viewProjection;uniform mat4 view;");const I="geometryUboDeclaration";e.IncludesShadersStore[I]||(e.IncludesShadersStore[I]="#include<sceneUboDeclaration>\n");const M="geometryVertexShader",L="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;\n#ifdef HAS_NORMAL_ATTRIBUTE\nattribute vec3 normal;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef METALLIC_TEXTURE\nvarying vec2 vMetallicUV;uniform mat4 metallicMatrix;\n#endif\n#ifdef ROUGHNESS_TEXTURE\nvarying vec2 vRoughnessUV;uniform mat4 roughnessMatrix;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef HAS_NORMAL_ATTRIBUTE\nvec3 normalUpdated=normal;\n#else\nvec3 normalUpdated=vec3(0.0,0.0,0.0);\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uvUpdated;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#else\n#ifdef METALLIC_UV1\nvMetallicUV=vec2(metallicMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ROUGHNESS_UV1\nvRoughnessUV=vec2(roughnessMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#else\nvUV=uv2Updated;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2Updated,1.0,0.0));\n#else\n#ifdef METALLIC_UV2\nvMetallicUV=vec2(metallicMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef ROUGHNESS_UV2\nvRoughnessUV=vec2(roughnessMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";e.ShadersStore[M]||(e.ShadersStore[M]=L);const P={name:M,shader:L};var S=Object.freeze({__proto__:null,geometryVertexShader:P});const U=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];E(U);class b{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===b.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===b.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===b.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=!0):e===b.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===b.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===b.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===b.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case b.POSITION_TEXTURE_TYPE:return this._positionIndex;case b.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case b.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case b.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case b.DEPTH_TEXTURE_TYPE:return this._depthIndex;case b.NORMAL_TEXTURE_TYPE:return this._normalIndex;case b.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,n=1,s=t.TEXTUREFORMAT_DEPTH16,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new i(0,0,0,0),this._clearDepthColor=new i(0,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=n,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=s,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),b._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!b.ForceGLSL?(this._shaderLanguage=1,await Promise.all([import("./geometry.vertex-4ZROSiVh.esm.min.js"),import("./geometry.fragment-DWJA6HGN.esm.min.js")])):await Promise.all([Promise.resolve().then((function(){return S})),Promise.resolve().then((function(){return x}))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const l=[],d=[n.PositionKind],u=e.getMesh();u.isVerticesDataPresent(n.NormalKind)&&(l.push("#define HAS_NORMAL_ATTRIBUTE"),d.push(n.NormalKind));let c=!1,f=!1;if(i){let e=!1;if(i.needAlphaTestingForMesh(u)&&i.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),l.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),(i.bumpTexture||i.normalTexture||i.geometryNormalTexture)&&s.BumpTextureEnabled){const t=i.bumpTexture||i.normalTexture||i.geometryNormalTexture;l.push("#define BUMP"),l.push(`#define BUMP_UV${t.coordinatesIndex+1}`),e=!0}if(this._enableReflectivity){let t=!1;if("PBRMetallicRoughnessMaterial"===i.getClassName())i.metallicRoughnessTexture&&(l.push("#define ORMTEXTURE"),l.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),l.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(l.push("#define METALLIC"),l.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(l.push("#define ROUGHNESS"),l.push("#define METALLICWORKFLOW"),t=!0),t&&(i.baseTexture&&(l.push("#define ALBEDOTEXTURE"),l.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&l.push("#define GAMMAALBEDO"),e=!0),i.baseColor&&l.push("#define ALBEDOCOLOR"));else if("PBRSpecularGlossinessMaterial"===i.getClassName())i.specularGlossinessTexture?(l.push("#define SPECULARGLOSSINESSTEXTURE"),l.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&l.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&l.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&l.push("#define GLOSSINESS");else if("PBRMaterial"===i.getClassName())i.metallicTexture&&(l.push("#define ORMTEXTURE"),l.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),l.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(l.push("#define METALLIC"),l.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(l.push("#define ROUGHNESS"),l.push("#define METALLICWORKFLOW"),t=!0),t?(i.albedoTexture&&(l.push("#define ALBEDOTEXTURE"),l.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&l.push("#define GAMMAALBEDO"),e=!0),i.albedoColor&&l.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(l.push("#define SPECULARGLOSSINESSTEXTURE"),l.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&l.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):i.reflectivityColor&&l.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&l.push("#define GLOSSINESS"));else if("StandardMaterial"===i.getClassName())i.specularTexture&&(l.push("#define REFLECTIVITYTEXTURE"),l.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&l.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),i.specularColor&&l.push("#define REFLECTIVITYCOLOR");else if("OpenPBRMaterial"===i.getClassName()){const n=i;l.push("#define METALLICWORKFLOW"),t=!0,l.push("#define METALLIC"),l.push("#define ROUGHNESS"),n._useRoughnessFromMetallicTextureGreen&&n.baseMetalnessTexture?(l.push("#define ORMTEXTURE"),l.push(`#define REFLECTIVITY_UV${n.baseMetalnessTexture.coordinatesIndex+1}`),e=!0):n.baseMetalnessTexture?(l.push("#define METALLIC_TEXTURE"),l.push(`#define METALLIC_UV${n.baseMetalnessTexture.coordinatesIndex+1}`),e=!0):n.specularRoughnessTexture&&(l.push("#define ROUGHNESS_TEXTURE"),l.push(`#define ROUGHNESS_UV${n.specularRoughnessTexture.coordinatesIndex+1}`),e=!0),n.baseColorTexture&&(l.push("#define ALBEDOTEXTURE"),l.push(`#define ALBEDO_UV${n.baseColorTexture.coordinatesIndex+1}`),n.baseColorTexture.gammaSpace&&l.push("#define GAMMAALBEDO"),e=!0),n.baseColor&&l.push("#define ALBEDOCOLOR")}}e&&(l.push("#define NEED_UV"),u.isVerticesDataPresent(n.UVKind)&&(d.push(n.UVKind),l.push("#define UV1"),c=!0),u.isVerticesDataPresent(n.UV2Kind)&&(d.push(n.UV2Kind),l.push("#define UV2"),f=!0))}this._enableDepth&&(l.push("#define DEPTH"),l.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(l.push("#define NORMAL"),l.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(l.push("#define POSITION"),l.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(l.push("#define VELOCITY"),l.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(u)&&l.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(l.push("#define VELOCITY_LINEAR"),l.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(u)&&l.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(l.push("#define REFLECTIVITY"),l.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(l.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),l.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&l.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&l.push("#define ENCODE_NORMAL"),u.useBones&&u.computeBonesUsingShaders&&u.skeleton?(d.push(n.MatricesIndicesKind),d.push(n.MatricesWeightsKind),u.numBoneInfluencers>4&&(d.push(n.MatricesIndicesExtraKind),d.push(n.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+u.numBoneInfluencers),l.push("#define BONETEXTURE "+u.skeleton.isUsingTextureForMatrices),l.push("#define BonesPerMesh "+(u.skeleton.bones.length+1))):(l.push("#define NUM_BONE_INFLUENCERS 0"),l.push("#define BONETEXTURE false"),l.push("#define BonesPerMesh 0"));const h=u.morphTargetManager?r(u.morphTargetManager,l,d,u,!0,!0,!1,c,f,!1):0;t&&(l.push("#define INSTANCES"),a(d,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this._linkedWithPrePass?l.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):l.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),o(i,this._scene,l);const T=this._scene.getEngine(),E=e._getDrawWrapper(void 0,!0),_=E.defines,p=l.join("\n");return _!==p&&E.setEffect(T.createEffect("geometry",{attributes:d,uniformsNames:U,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:p,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:h},shaderLanguage:this.shaderLanguage},T),p),E.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){if(this._resizeObserver){this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null}this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[b.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[b.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[b.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[b.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[b.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[b.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[b.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[i,n,r]=this._assignRenderTargetIndices();let a=t.TEXTURETYPE_UNSIGNED_BYTE;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?a=t.TEXTURETYPE_FLOAT:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(a=t.TEXTURETYPE_HALF_FLOAT);const o=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},E=[],_=[];for(const e of r)e?(E.push(e.textureType),_.push(e.textureFormat)):(E.push(a),_.push(t.TEXTUREFORMAT_RGBA));if(this._normalsAreUnsigned=E[b.NORMAL_TEXTURE_TYPE]===t.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV||E[b.NORMAL_TEXTURE_TYPE]===t.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV,this._multiRenderTarget=new l("gBuffer",o,i,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:E,formats:_,depthTextureFormat:this._depthFormat},n.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=d.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=d.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const p=[!0],m=[!1],v=[!0];for(let e=1;e<i;++e)p.push(!0),v.push(!1),m.push(!0);const g=e.buildTextureLayout(p),x=e.buildTextureLayout(m),R=e.buildTextureLayout(v);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?x:g),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(R),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(g)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const I=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),n=this._scene,r=n.getEngine(),a=e.getMaterial();if(!a)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:u.Identity(),viewProjection:n.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const l=r.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances),d=i.getWorldMatrix();if(this.isReady(e,l)){const u=e._getDrawWrapper();if(!u)return;const E=u.effect;let _;r.enableEffect(u),l||t._bind(e,E,a.fillMode),this._useUbo?(c(E,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(E.setMatrix("viewProjection",n.getTransformMatrix()),E.setMatrix("view",n.getViewMatrix()));if(t._instanceDataStorage.isFrozen||!a.backFaceCulling&&null===a.sideOrientation)_=t._effectiveSideOrientation;else{const e=i._getWorldMatrixDeterminant();_=a._getEffectiveOrientation(t),e<0&&(_=_===T.ClockWiseSideOrientation?T.CounterClockWiseSideOrientation:T.ClockWiseSideOrientation)}if(a._preBind(u,_),a.needAlphaTestingForMesh(i)){const e=a.getAlphaTestTexture();e&&(E.setTexture("diffuseSampler",e),E.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if((a.bumpTexture||a.normalTexture||a.geometryNormalTexture)&&n.getEngine().getCaps().standardDerivatives&&s.BumpTextureEnabled){const e=a.bumpTexture||a.normalTexture||a.geometryNormalTexture;E.setFloat3("vBumpInfos",e.coordinatesIndex,1/e.level,a.parallaxScaleBias),E.setMatrix("bumpMatrix",e.getTextureMatrix()),E.setTexture("bumpSampler",e),E.setFloat2("vTangentSpaceParams",a.invertNormalMapX?-1:1,a.invertNormalMapY?-1:1)}if(this._enableReflectivity)if("PBRMetallicRoughnessMaterial"===a.getClassName())null!==a.metallicRoughnessTexture&&(E.setTexture("reflectivitySampler",a.metallicRoughnessTexture),E.setMatrix("reflectivityMatrix",a.metallicRoughnessTexture.getTextureMatrix())),null!==a.metallic&&E.setFloat("metallic",a.metallic),null!==a.roughness&&E.setFloat("glossiness",1-a.roughness),null!==a.baseTexture&&(E.setTexture("albedoSampler",a.baseTexture),E.setMatrix("albedoMatrix",a.baseTexture.getTextureMatrix())),null!==a.baseColor&&E.setColor3("albedoColor",a.baseColor);else if("PBRSpecularGlossinessMaterial"===a.getClassName())null!==a.specularGlossinessTexture?(E.setTexture("reflectivitySampler",a.specularGlossinessTexture),E.setMatrix("reflectivityMatrix",a.specularGlossinessTexture.getTextureMatrix())):null!==a.specularColor&&E.setColor3("reflectivityColor",a.specularColor),null!==a.glossiness&&E.setFloat("glossiness",a.glossiness);else if("PBRMaterial"===a.getClassName())null!==a.metallicTexture&&(E.setTexture("reflectivitySampler",a.metallicTexture),E.setMatrix("reflectivityMatrix",a.metallicTexture.getTextureMatrix())),null!==a.metallic&&E.setFloat("metallic",a.metallic),null!==a.roughness&&E.setFloat("glossiness",1-a.roughness),null!==a.roughness||null!==a.metallic||null!==a.metallicTexture?(null!==a.albedoTexture&&(E.setTexture("albedoSampler",a.albedoTexture),E.setMatrix("albedoMatrix",a.albedoTexture.getTextureMatrix())),null!==a.albedoColor&&E.setColor3("albedoColor",a.albedoColor)):(null!==a.reflectivityTexture?(E.setTexture("reflectivitySampler",a.reflectivityTexture),E.setMatrix("reflectivityMatrix",a.reflectivityTexture.getTextureMatrix())):null!==a.reflectivityColor&&E.setColor3("reflectivityColor",a.reflectivityColor),null!==a.microSurface&&E.setFloat("glossiness",a.microSurface));else if("StandardMaterial"===a.getClassName())null!==a.specularTexture&&(E.setTexture("reflectivitySampler",a.specularTexture),E.setMatrix("reflectivityMatrix",a.specularTexture.getTextureMatrix())),null!==a.specularColor&&E.setColor3("reflectivityColor",a.specularColor);else if("OpenPBRMaterial"===a.getClassName()){const e=a;e._useRoughnessFromMetallicTextureGreen&&e.baseMetalnessTexture?(E.setTexture("reflectivitySampler",e.baseMetalnessTexture),E.setMatrix("reflectivityMatrix",e.baseMetalnessTexture.getTextureMatrix())):e.baseMetalnessTexture?(E.setTexture("metallicSampler",e.baseMetalnessTexture),E.setMatrix("metallicMatrix",e.baseMetalnessTexture.getTextureMatrix())):e.specularRoughnessTexture&&(E.setTexture("roughnessSampler",e.specularRoughnessTexture),E.setMatrix("roughnessMatrix",e.specularRoughnessTexture.getTextureMatrix())),E.setFloat("metallic",e.baseMetalness),E.setFloat("glossiness",1-e.specularRoughness),null!==e.baseColorTexture&&(E.setTexture("albedoSampler",e.baseColorTexture),E.setMatrix("albedoMatrix",e.baseColorTexture.getTextureMatrix())),null!==e.baseColor&&E.setColor3("albedoColor",e.baseColor)}if(f(E,a,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&E.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);E.setTexture("boneSampler",i),E.setFloat("boneTextureWidth",4*(e.bones.length+1))}else E.setMatrices("mBones",t.skeleton.getTransformMatrices(t));(this._enableVelocity||this._enableVelocityLinear)&&E.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}h(t,E),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(E),(this._enableVelocity||this._enableVelocityLinear)&&(E.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),E.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),l&&t.hasThinInstances&&E.setMatrix("world",d),t._processRendering(i,e,E,a.fillMode,o,l,((e,t)=>{e||E.setMatrix("world",t)}))}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[i.uniqueId].world=d.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,n)=>{if((n||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const n=t.subMeshes[i],s=n.getMaterial(),r=n.getRenderingMesh();if(!s)continue;const a=r._getInstancesRenderList(n._id,!!n.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==a.visibleInstances[n._id]||r.hasThinInstances);if(!this.isReady(n,o))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,n,s)=>{let r;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(s.length){for(e.setColorWrite(!1),r=0;r<s.length;r++)I(s.data[r]);e.setColorWrite(!0)}for(r=0;r<t.length;r++)I(t.data[r]);for(e.setDepthWrite(!1),r=0;r<i.length;r++)I(i.data[r]);if(this.renderTransparentMeshes)for(r=0;r<n.length;r++)I(n.data[r]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}b.ForceGLSL=!1,b.DEPTH_TEXTURE_TYPE=0,b.NORMAL_TEXTURE_TYPE=1,b.POSITION_TEXTURE_TYPE=2,b.VELOCITY_TEXTURE_TYPE=3,b.REFLECTIVITY_TEXTURE_TYPE=4,b.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,b.VELOCITY_LINEAR_TEXTURE_TYPE=6,b._SceneComponentInitialization=e=>{throw _("GeometryBufferRendererSceneComponent")};export{b as G};
//# sourceMappingURL=geometryBufferRenderer-CBcpWw_c.esm.min.js.map
