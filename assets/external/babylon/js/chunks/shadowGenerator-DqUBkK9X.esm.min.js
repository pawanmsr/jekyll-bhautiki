import{f as e,T as t,C as s,a9 as i,S as r,_ as a,aa as n,s as o,g as h,O as l,b as d,p as u,y as p,a7 as _,h as c,ab as f,V as g,a1 as S,ac as M,d as E,a4 as T,$ as m,Z as w,Y as L,J as x,a3 as P,N as A,X as I,W as B,a0 as O,ad as b,j as R}from"./index-C7lpuH7l.esm.min.js";class F extends e{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,r,a,n,o=null,h=t.BILINEAR_SAMPLINGMODE,l,d,u=s.TEXTURETYPE_UNSIGNED_BYTE,p="",_=!1,c=s.TEXTUREFORMAT_RGBA){const f="number"==typeof n?_:!!n.blockCompilation,g={uniforms:i.Uniforms,samplers:i.Samplers,size:"number"==typeof n?n:void 0,camera:o,samplingMode:h,engine:l,reusable:d,textureType:u,vertexUrl:i.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:c,defines:p,...n,blockCompilation:!0};super(e,i.FragmentUrl,{effectWrapper:"number"!=typeof n&&n.effectWrapper?void 0:new i(e,l,void 0,void 0,g),...g}),this._effectWrapper.options.blockCompilation=f,this.direction=r,this.onApplyObservable.add((()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height})),this.kernel=a}updateEffect(e=null,t=null,s=null,i,r,a){this._effectWrapper._updateParameters(r,a)}static _Parse(e,t,s,i){return r.Parse((()=>new F(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,void 0,!1)),e,s,i)}}a([n()],F.prototype,"direction",null),a([o()],F.prototype,"kernel",null),a([o()],F.prototype,"packedFloat",null),h("BABYLON.BlurPostProcess",F);class N{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===N.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===N.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===N.FILTER_PCF||e===N.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==N.FILTER_PCF&&e!==N.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===N.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(N.FILTER_POISSONSAMPLING);(e||this.filter===N.FILTER_POISSONSAMPLING)&&(this.filter=e?t:N.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===N.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(N.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===N.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:N.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===N.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(N.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===N.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:N.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===N.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(N.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===N.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:N.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===N.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(N.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===N.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:N.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===N.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(N.FILTER_PCF);(e||this.filter===N.FILTER_PCF)&&(this.filter=e?t:N.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===N.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(N.FILTER_PCSS);(e||this.filter===N.FILTER_PCSS)&&(this.filter=e?t:N.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return N.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const s=this._shadowMap.renderList.indexOf(e);if(-1!==s&&this._shadowMap.renderList.splice(s,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,a,n=!1){this.onBeforeShadowMapRenderObservable=new l,this.onAfterShadowMapRenderObservable=new l,this.onBeforeShadowMapRenderMeshObservable=new l,this.onAfterShadowMapRenderMeshObservable=new l,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=N.FILTER_NONE,this._filteringQuality=N.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=d.Zero(),this._viewMatrix=u.Zero(),this._projectionMatrix=u.Zero(),this._transformMatrix=u.Zero(),this._cachedPosition=new d(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new d(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=u.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(n);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`,{forceMono:!0})]),N._SceneComponentInitialization(this._scene);const h=this._scene.getEngine().getCaps();i?h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=s.TEXTURETYPE_FLOAT:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=s.TEXTURETYPE_HALF_FLOAT:this._textureType=s.TEXTURETYPE_UNSIGNED_BYTE:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=s.TEXTURETYPE_HALF_FLOAT:h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=s.TEXTURETYPE_FLOAT:this._textureType=s.TEXTURETYPE_UNSIGNED_BYTE,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap?.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new p(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?s.TEXTUREFORMAT_RED:s.TEXTUREFORMAT_RGBA),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?s.GREATER:s.LESS,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new p(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=t.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=t.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(t.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,s,i)=>this._renderForShadowMap(e,t,s,i),this._shadowMap.customIsReadyFunction=(e,t,s)=>{if(!s||!e.subMeshes)return!0;let i=!0;for(const t of e.subMeshes){const e=t.getRenderingMesh(),s=this._scene.getEngine(),r=t.getMaterial();if(!r||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;const a=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(a.mustReturn)continue;const n=s.getCaps().instancedArrays&&(null!==a.visibleInstances[t._id]&&void 0!==a.visibleInstances[t._id]||e.hasThinInstances),o=r.needAlphaBlendingForMesh(e);i=this.isReady(t,n,o)&&i}return i};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._enableGPUDebugMarkers&&(e.restoreDefaultFramebuffer(!0),e._debugPushGroup?.(`Shadow map generation for pass id ${e.currentRenderPassId}`))})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===N.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),_.eyeAtCamera=!1,this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._sceneUBOs&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),_.eyeAtCamera=!0,this._scene.updateTransformMatrix(),this._filter===N.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.();const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0)),e._enableGPUDebugMarkers&&e._debugPopGroup?.()}));const s=new c(0,0,0,0),i=new c(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===N.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(s,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=f.MIN_RENDERINGGROUPS;e<f.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||N.ForceGLSL?await Promise.all([import("./shadowMap.fragment-DQq8HZlV.esm.min.js"),import("./shadowMap.vertex-DI7AXKAL.esm.min.js"),import("./depthBoxBlur.fragment-Ce8KHo4i.esm.min.js"),import("./shadowMapFragmentSoftTransparentShadow-PD--HXWl.esm.min.js")]):(this._shaderLanguage=1,await Promise.all([import("./shadowMap.fragment-5DaSHSX8.esm.min.js"),import("./shadowMap.vertex-vapdDCIv.esm.min.js"),import("./depthBoxBlur.fragment-DJ_zh9N8.esm.min.js"),import("./shadowMapFragmentSoftTransparentShadow-CI8Fvb6s.esm.min.js")])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const i=this._scene.getEngine(),r=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new p(this._light.name+"_shadowMap2",r,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=t.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=t.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(t.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new F(this._light.name+"KernelBlurX",new g(1,0),this.blurKernel,1,null,t.BILINEAR_SAMPLINGMODE,i,!1,this._textureType),this._kernelBlurXPostprocess.width=r,this._kernelBlurXPostprocess.height=r,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new F(this._light.name+"KernelBlurY",new g(0,1),this.blurKernel,1,null,t.BILINEAR_SAMPLINGMODE,i,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===s.TEXTURETYPE_UNSIGNED_BYTE&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new e(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,t.BILINEAR_SAMPLINGMODE,i,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",r,r),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,s,i){let r;if(i.length)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r],!0);else for(r=0;r<s.length;r++)s.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,s){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const i=e.getRenderingMesh(),r=e.getEffectiveMesh(),a=this._scene,n=a.getEngine(),o=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||0===e.verticesCount||e._renderId===a.getRenderId())return;const h=a.useRightHandedSystem,l=r._getWorldMatrixDeterminant()<0;let d=o._getEffectiveOrientation(i);(l&&!h||!l&&h)&&(d=d===s.MATERIAL_ClockWiseSideOrientation?s.MATERIAL_CounterClockWiseSideOrientation:s.MATERIAL_ClockWiseSideOrientation);const u=d===s.MATERIAL_ClockWiseSideOrientation;n.setState(o.backFaceCulling,void 0,void 0,u,o.cullBackFaces);const p=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(p.mustReturn)return;const _=n.getCaps().instancedArrays&&(null!==p.visibleInstances[e._id]&&void 0!==p.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,_,t)){e._renderId=a.getRenderId();const s=o.shadowDepthWrapper,h=s?.getEffect(e,this,n.currentRenderPassId)??e._getDrawWrapper(),l=S.GetEffect(h);n.enableEffect(h),_||i._bind(e,l,o.fillMode),this.getTransformMatrix(),l.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===M.LIGHTTYPEID_DIRECTIONALLIGHT?l.setVector3("lightDataSM",this._cachedDirection):l.setVector3("lightDataSM",this._cachedPosition.subtractToRef(this._scene.floatingOriginOffset,E.Vector3[0]));const d=this._getCamera();if(l.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(d),this.getLight().getDepthMinZ(d)+this.getLight().getDepthMaxZ(d)),t&&this.enableSoftTransparentShadow&&l.setFloat2("softTransparentShadowSM",r.visibility*o.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),s)e._setMainDrawWrapperOverride(h),s.standalone?s.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):o.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{this._opacityTexture&&(l.setTexture("diffuseSampler",this._opacityTexture),l.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),T(i,l),m(i,l),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(l);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(l,_),w(l,o,a)}this._useUBO||s||this._bindCustomEffectForRenderSubMeshForShadowMap(e,l,r),L(l,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const u=r.getWorldMatrix();_&&(r.getMeshUniformBuffer().bindToEffect(l,"Mesh"),r.transferToEffect(u)),this.forceBackFacesOnly&&n.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(l),i._processRendering(r,e,l,o.fillMode,p,_,((e,t)=>{r===i||e?(r.getMeshUniformBuffer().bindToEffect(l,"Mesh"),r.transferToEffect(e?t:u)):(i.getMeshUniformBuffer().bindToEffect(l,"Mesh"),i.transferToEffect(t))})),this.forceBackFacesOnly&&n.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(l),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===N.FILTER_NONE||this.filter===N.FILTER_PCSS?this._shadowMap.updateSamplingMode(t.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(t.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const s={useInstances:!1,...t},i=this.getShadowMap();if(!i)return void(e&&e(this));const r=i.renderList;if(!r)return void(e&&e(this));const a=[];for(const e of r)a.push(...e.subMeshes);if(0===a.length)return void(e&&e(this));let n=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(a[n],s.useInstances,a[n].getMaterial()?.needAlphaBlendingForMesh(a[n].getMesh())??!1);)if(n++,n>=a.length)return void(e&&e(this));setTimeout(o,16)}};o()}async forceCompilationAsync(e){return await new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,s){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==s.TEXTURETYPE_UNSIGNED_BYTE?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const a=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(x.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===M.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,s){if(!this._shadersLoaded)return!1;const i=e.getMaterial(),r=i?.shadowDepthWrapper;if(this._opacityTexture=null,!i)return!1;const a=[];if(this._prepareShadowDefines(e,t,a,s),r){if(!r.isReadyForSubMesh(e,a,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const s=e._getDrawWrapper(void 0,!0);let r=s.effect,n=s.defines;const o=[x.PositionKind],h=e.getMesh();let l=!1,d=!1,u=!1;const p=!1;this.normalBias&&h.isVerticesDataPresent(x.NormalKind)&&(o.push(x.NormalKind),a.push("#define NORMAL"),l=!0,h.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));const _=i.needAlphaTestingForMesh(h);if((_||i.needAlphaBlendingForMesh(h))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=i.opacityTexture:this._opacityTexture=i.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=i.alphaCutOff??N.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),_&&a.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),h.isVerticesDataPresent(x.UVKind)&&(o.push(x.UVKind),a.push("#define UV1"),d=!0),h.isVerticesDataPresent(x.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(o.push(x.UV2Kind),a.push("#define UV2"),u=!0)}const c=new P;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){o.push(x.MatricesIndicesKind),o.push(x.MatricesWeightsKind),h.numBoneInfluencers>4&&(o.push(x.MatricesIndicesExtraKind),o.push(x.MatricesWeightsExtraKind));const e=h.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,h),e.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(e.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");const f=h.morphTargetManager?A(h.morphTargetManager,a,o,h,!0,l,!1,d,u,p):0;if(I(i,this._scene,a),t&&(a.push("#define INSTANCES"),B(o),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===a.indexOf(e)&&a.push(e);const g=h.bakedVertexAnimationManager;g&&g.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&o.push("bakedVertexAnimationSettingsInstanced"));const S=a.join("\n");if(n!==S){n=S;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],i=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],a=["Scene","Mesh"];if(O(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===o.indexOf(e)&&o.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===i.indexOf(e)&&i.push(e)}const h=this._scene.getEngine();r=h.createEffect(e,{attributes:o,uniformsNames:t,uniformBuffersNames:a,samplers:i,defines:S,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:f},shaderLanguage:this._shaderLanguage},h),s.setEffect(r,n)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady())&&(!(this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady())&&!(this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()))}prepareDefines(e,t){const s=this._scene,i=this._light;s.shadowsEnabled&&i.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===N.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===N.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===N.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===N.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),i.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const s=this._light,i=this._scene;if(!i.shadowsEnabled||!s.shadowEnabled)return;const r=this._getCamera(),a=this.getShadowMap();if(!a)return;if(!s.needCube()){const s=i.floatingOriginOffset,r=this.getTransformMatrix(),a=i.floatingOriginMode?b(s,this._viewMatrix,this._projectionMatrix,E.Matrix[0]):r;t.setMatrix("lightMatrix"+e,a)}const n=this.getShadowMapForRendering();this._filter===N.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,n),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,e)):this._filter===N.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,n),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),d.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(d.Dot(this._lightDirection,d.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),u.LookAtLHToRef(t,t.add(this._lightDirection),d.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,s]=t.value;s===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let s=0;s<t.renderList.length;s++){const i=t.renderList[s];e.renderList.push(i.id)}return e}static Parse(e,t,s){const i=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,a=s?s(e.mapSize,i,r):new N(e.mapSize,i,void 0,r),n=a.getShadowMap();if(e.renderList.length&&n){const s=new Set(e.renderList);let i=n.renderList;i||(i=n.renderList=[]);const r=t.meshes;for(const e of r)s.has(e.id)&&i.push(e)}return void 0!==e.id&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(a.bias=e.bias),void 0!==e.normalBias&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a}}N.CLASSNAME="ShadowGenerator",N.ForceGLSL=!1,N.FILTER_NONE=0,N.FILTER_EXPONENTIALSHADOWMAP=1,N.FILTER_POISSONSAMPLING=2,N.FILTER_BLUREXPONENTIALSHADOWMAP=3,N.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,N.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,N.FILTER_PCF=6,N.FILTER_PCSS=7,N.QUALITY_HIGH=0,N.QUALITY_MEDIUM=1,N.QUALITY_LOW=2,N.DEFAULT_ALPHA_CUTOFF=.5,N._SceneComponentInitialization=e=>{throw R("ShadowGeneratorSceneComponent")};export{N as ShadowGenerator};
//# sourceMappingURL=shadowGenerator-DqUBkK9X.esm.min.js.map
