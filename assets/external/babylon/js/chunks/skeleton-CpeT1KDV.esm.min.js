import{B as e}from"./bone-C8BOn9ne.esm.min.js";import{p as t,O as n,e as s,bE as i,L as r,aJ as a,d as o,C as h,bB as m,b as l}from"./index-C7lpuH7l.esm.min.js";import{R as d}from"./rawTexture-GcKYJ37d.esm.min.js";class u{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,i,r){this.name=e,this.id=i,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=t.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new n,this.metadata=null,this.bones=[],this._scene=r||s.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const a=this._scene.getEngine().getCaps();this._canUseTextureForBones=a.textureFloat&&a.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((e=>!e.getParent()))}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(const n in this._ranges)e&&(t+=", ",e=!1),t+=n;t+="}"}return t}getBoneIndexByName(e){for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].name===e)return t;return-1}findBoneFromLinkedTransformNode(e){for(const t of this.bones)if(t._linkedTransformNode===e)return t;return null}findBoneFromLinkedTransformNodeName(e){for(const t of this.bones)if(t._linkedTransformNode&&t._linkedTransformNode.name===e)return t;return null}createAnimationRange(e,t,n){if(!this._ranges[e]){this._ranges[e]=new i(e,t,n);for(let s=0,i=this.bones.length;s<i;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,n)}}deleteAnimationRange(e,t=!0){for(let n=0,s=this.bones.length;n<s;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,n=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const a=this._getHighestAnimationFrame()+1,o={},h=e.bones;let m,l;for(l=0,m=h.length;l<m;l++)o[h[l].name]=h[l];this.bones.length!==h.length&&(r.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${h.length}`),s=!1);const d=n&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(l=0,m=this.bones.length;l<m;l++){const e=this.bones[l].name,i=o[e];i?s=s&&this.bones[l].copyAnimationRange(i,t,a,n,d):(r.Warn("copyAnimationRange: not same rig, missing source bone "+e),s=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new i(t,u.from+a,u.to+a)),s}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].animations[0]){const n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,t,n,s){const i=this.getAnimationRange(e);return i?this._scene.beginAnimation(this,i.from,i.to,t,n,s):null}static MakeAnimationAdditive(e,t=0,n){const s=e.getAnimationRange(n);if(!s)return null;const i=e._scene.getAllAnimatablesByTarget(e);let r=null;for(let e=0;e<i.length;e++){const t=i[e];if(t.fromFrame===s?.from&&t.toFrame===s?.to){r=t;break}}const o=e.getAnimatables();for(let e=0;e<o.length;e++){const s=o[e].animations;if(s)for(let e=0;e<s.length;e++)a.MakeAnimationAdditive(s[e],t,n)}return r&&(r.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const s=this.bones[n];s._childUpdateId++;const i=s.getParent();if(i?s.getLocalMatrix().multiplyToRef(i.getFinalMatrix(),s.getFinalMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getFinalMatrix()):s.getFinalMatrix().copyFrom(s.getLocalMatrix()),-1!==s._index){const t=null===s._index?n:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(s.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let n=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),n=!0),n){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)if(!e.getParent()){e.getBindMatrix().multiplyToRef(t,o.Matrix[1]),e._updateAbsoluteBindMatrices(o.Matrix[1])}if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=d.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,h.TEXTURE_NEAREST_SAMPLINGMODE,h.TEXTURETYPE_FLOAT))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=d.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,h.TEXTURE_NEAREST_SAMPLINGMODE,h.TEXTURETYPE_FLOAT))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(t,n){const s=new u(t,n||t,this._scene);s.needInitialSkinMatrix=this.needInitialSkinMatrix,s.metadata=this.metadata;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];let i=null;const r=n.getParent();if(r){const e=this.bones.indexOf(r);i=s.bones[e]}const a=new e(n.name,s,i,n.getBindMatrix().clone(),n.getRestMatrix().clone());a._index=n._index,n._linkedTransformNode&&a.linkTransformNode(n._linkedTransformNode),m.DeepCopy(n.animations,a.animations)}if(this._ranges){s._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(s._ranges[e]=t.clone())}}return this._isDirty=!0,s.prepare(!0),s}enableBlending(e=.01){for(const t of this.bones)for(const n of t.animations)n.enableBlending=!0,n.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let t=0;t<this.bones.length;t++){const n=this.bones[t],s=n.getParent(),i={parentBoneIndex:s?this.bones.indexOf(s):-1,index:n.getIndex(),name:n.name,id:n.id,uniqueId:n.uniqueId,matrix:n.getBindMatrix().asArray(),rest:n.getRestMatrix().asArray(),linkedTransformNodeId:n.getTransformNode()?.id,linkedTransformNodeUniqueId:n.getTransformNode()?.uniqueId};e.bones.push(i),n.length&&(i.length=n.length),n.metadata&&(i.metadata=n.metadata),n.animations&&n.animations.length>0&&(i.animation=n.animations[0].serialize()),e.ranges=[];for(const t in this._ranges){const n=this._ranges[t];if(!n)continue;const s={};s.name=t,s.from=n.from,s.to=n.to,e.ranges.push(s)}}return e}static Parse(n,s){const i=new u(n.name,n.id,s);let r;for(n.dimensionsAtRest&&(i.dimensionsAtRest=l.FromArray(n.dimensionsAtRest)),i.needInitialSkinMatrix=n.needInitialSkinMatrix,n.metadata&&(i.metadata=n.metadata),r=0;r<n.bones.length;r++){const s=n.bones[r],o=n.bones[r].index;let h=null;s.parentBoneIndex>-1&&(h=i.bones[s.parentBoneIndex]);const m=s.rest?t.FromArray(s.rest):null,l=new e(s.name,i,h,t.FromArray(s.matrix),m,null,o);void 0!==s.id&&null!==s.id&&(l.id=s.id),s.length&&(l.length=s.length),s.metadata&&(l.metadata=s.metadata),s.animation&&l.animations.push(a.Parse(s.animation)),void 0!==s.linkedTransformNodeId&&null!==s.linkedTransformNodeId&&(i._hasWaitingData=!0,l._waitingTransformNodeId=s.linkedTransformNodeId),void 0!==s.linkedTransformNodeUniqueId&&null!==s.linkedTransformNodeUniqueId&&(i._hasWaitingData=!0,l._waitingTransformNodeUniqueId=s.linkedTransformNodeUniqueId)}if(n.ranges)for(r=0;r<n.ranges.length;r++){const e=n.ranges[r];i.createAnimationRange(e.name,e.from,e.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let n=0;n<this.bones.length;n++)this._sortBones(n,e,t);this.bones=e}_sortBones(e,t,n){if(n[e])return;n[e]=!0;const s=this.bones[e];if(!s)return;void 0===s._index&&(s._index=e);const i=s.getParent();i&&this._sortBones(this.bones.indexOf(i),t,n),t.push(s)}setCurrentPoseAsRest(){for(const e of this.bones)e.setCurrentPoseAsRest()}}export{u as S};
//# sourceMappingURL=skeleton-CpeT1KDV.esm.min.js.map
